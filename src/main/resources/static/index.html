<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Khách Sạn (HMS)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: white; }
        .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; border-radius: 5px; }
        .nav-link:hover, .nav-link.active { background-color: #3498db; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card { border: none; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .status-PENDING { background-color: #f1c40f; color: #fff; }
        .status-CONFIRMED { background-color: #3498db; color: #fff; }
        .status-CHECKED_IN { background-color: #2ecc71; color: #fff; }
        .status-CHECKED_OUT { background-color: #95a5a6; color: #fff; }
        .status-CANCELLED { background-color: #e74c3c; color: #fff; }
        .main-content { padding: 20px; }

        /* Room Map Styles */
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .room-card { cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; border: 1px solid #eee; }
        .room-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .room-card.status-AVAILABLE { border-top: 5px solid #2ecc71; }
        .room-card.status-OCCUPIED { border-top: 5px solid #e74c3c; background-color: #fff5f5; }
        .room-card.status-MAINTENANCE, .room-card.status-DIRTY { border-top: 5px solid #f1c40f; background-color: #fffff0; }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar p-3 d-flex flex-column" style="width: 280px; flex-shrink: 0;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <i class="fa-solid fa-hotel fa-2x me-2"></i>
                <span class="fs-4 fw-bold">HMS Admin</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('dashboard', this)">
                        <i class="fa-solid fa-chart-pie me-2"></i> Tổng quan
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" onclick="showSection('room-map', this)">
                        <i class="fa-solid fa-border-all me-2"></i> Sơ đồ phòng
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" onclick="showSection('guests', this)">
                        <i class="fa-solid fa-users me-2"></i> Khách hàng
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" onclick="showSection('reservations', this)">
                        <i class="fa-solid fa-calendar-check me-2"></i> Đặt phòng
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" onclick="showSection('services-inventory', this)">
                        <i class="fa-solid fa-bell-concierge me-2"></i> Dịch vụ & Kho
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" onclick="showSection('analytics', this)">
                        <i class="fa-solid fa-chart-line me-2"></i> Báo cáo & Phân tích
                    </a>
                </li>
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                    <img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2">
                    <strong>Admin</strong>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow-1 main-content">
            
            <!-- Section: Dashboard -->
            <div id="dashboard" class="content-section">
                <h2 class="mb-4">Tổng quan hệ thống</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card p-3 bg-primary text-white h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Phòng đang thuê</h5>
                                    <h2 class="fw-bold" id="dash-occupied">Loading...</h2>
                                </div>
                                <i class="fa-solid fa-bed fa-3x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 bg-success text-white h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Doanh thu tháng</h5>
                                    <h2 class="fw-bold" id="dash-revenue">Loading...</h2>
                                </div>
                                <i class="fa-solid fa-money-bill-wave fa-3x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 bg-warning text-dark h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Khách mới</h5>
                                    <h2 class="fw-bold" id="dash-guests">Loading...</h2>
                                </div>
                                <i class="fa-solid fa-user-plus fa-3x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts & Notifications Row -->
                <div class="row g-4 mt-2">
                    <!-- Room Status Chart -->
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <h5 class="card-title mb-3">Trạng thái phòng</h5>
                            <div style="height: 250px; position: relative;">
                                <canvas id="roomStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Revenue Chart -->
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <h5 class="card-title mb-3">Biểu đồ doanh thu (Tuần)</h5>
                            <div style="height: 250px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Notifications -->
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <h5 class="card-title mb-3">Thông báo nhanh</h5>
                            <div class="list-group list-group-flush" id="dash-notifications">
                                <div class="text-center text-muted mt-5"><i class="fa-solid fa-spinner fa-spin"></i> Đang tải...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Room Map -->
            <div id="room-map" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Sơ đồ phòng</h2>
                    <div>
                        <span class="badge bg-success me-2">Trống</span>
                        <span class="badge bg-danger me-2">Có khách</span>
                        <span class="badge bg-warning text-dark">Bảo trì / Dọn dẹp</span>
                    </div>
                </div>
                <div class="room-grid" id="room-grid-container">
                    <!-- Room cards will be injected here -->
                </div>
            </div>

            <!-- Section: Guests -->
            <div id="guests" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Danh sách Khách hàng</h2>
                    <div>
                        <div class="input-group d-inline-flex w-auto me-2">
                            <input type="text" id="guest-search" class="form-control" placeholder="Tìm kiếm..." onkeyup="searchGuest(this.value)">
                        </div>
                        <button class="btn btn-primary" onclick="openGuestModal()"><i class="fa-solid fa-plus"></i> Thêm mới</button>
                    </div>
                </div>
                <div class="card p-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="guest-table-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section: Reservations -->
            <div id="reservations" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Quản lý Đặt phòng</h2>
                    <button class="btn btn-primary" onclick="openReservationModal()"><i class="fa-solid fa-plus"></i> Tạo đơn đặt</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Phòng</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Trạng thái</th>
                                <th>Tổng tiền</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="reservation-table-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section: Services & Inventory -->
            <div id="services-inventory" class="content-section d-none">
                <h2 class="mb-4">Quản lý Dịch vụ & Kho</h2>
                
                <ul class="nav nav-tabs mb-3" id="siTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-services">Dịch vụ Khách sạn</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventory">Kho Vật tư</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Tab Services -->
                    <div class="tab-pane fade show active" id="tab-services">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary" onclick="openServiceModal()"><i class="fa-solid fa-plus"></i> Thêm Dịch vụ</button>
                        </div>
                        <div class="card p-3">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tên dịch vụ</th>
                                        <th>Giá tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="services-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Inventory -->
                    <div class="tab-pane fade" id="tab-inventory">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary" onclick="openInventoryModal()"><i class="fa-solid fa-plus"></i> Nhập kho</button>
                        </div>
                        <div class="card p-3">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tên vật tư</th>
                                        <th>Phân loại</th>
                                        <th>Tồn kho</th>
                                        <th>Đơn vị</th>
                                        <th>Cập nhật</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Analytics -->
            <div id="analytics" class="content-section d-none">
                <h2 class="mb-4">Báo cáo & Phân tích dữ liệu</h2>
                
                <div class="row g-4">
                    <!-- Occupancy Rate Chart -->
                    <div class="col-md-8">
                        <div class="card p-4 h-100">
                            <h5 class="card-title mb-4"><i class="fa-solid fa-chart-column text-primary"></i> Công suất phòng 6 tháng gần nhất (%)</h5>
                            <div style="height: 300px;">
                                <canvas id="occupancyHistoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Guests -->
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <h5 class="card-title mb-3"><i class="fa-solid fa-crown text-warning"></i> Top Khách hàng thân thiết</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Khách hàng</th>
                                        <th class="text-end">Điểm</th>
                                    </tr>
                                </thead>
                                <tbody id="top-guests-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALS -->
    <!-- Guest Modal -->
    <div class="modal fade" id="guestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="guestModalLabel">Thông tin Khách hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="guestForm">
                        <input type="hidden" id="guestId">
                        <div class="mb-3"><label class="form-label">Họ đệm</label><input type="text" class="form-control" id="firstName" required></div>
                        <div class="mb-3"><label class="form-label">Tên</label><input type="text" class="form-control" id="lastName" required></div>
                        <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="email" required></div>
                        <div class="mb-3"><label class="form-label">Số điện thoại</label><input type="text" class="form-control" id="phoneNumber" required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="saveGuest()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Modal -->
    <div class="modal fade" id="reservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo Đặt phòng mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reservationForm">
                        <div class="mb-3"><label class="form-label">ID Khách hàng</label><input type="number" class="form-control" id="resGuestId" required></div>
                        <div class="mb-3"><label class="form-label">ID Phòng</label><input type="number" class="form-control" id="resRoomId" required></div>
                        <div class="mb-3"><label class="form-label">Ngày Check-in</label><input type="date" class="form-control" id="checkInDate" required></div>
                        <div class="mb-3"><label class="form-label">Ngày Check-out</label><input type="date" class="form-control" id="checkOutDate" required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="createReservation()">Tạo đơn</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết Hóa đơn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceContent">
                    <!-- Invoice details loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Thêm Dịch vụ mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="serviceForm">
                        <div class="mb-3"><label class="form-label">Tên dịch vụ</label><input type="text" class="form-control" id="svcName" required></div>
                        <div class="mb-3"><label class="form-label">Giá tiền (VNĐ)</label><input type="number" class="form-control" id="svcPrice" required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveService()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal fade" id="inventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Thêm Vật tư mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="inventoryForm">
                        <div class="mb-3"><label class="form-label">Tên vật tư</label><input type="text" class="form-control" id="invName" required></div>
                        <div class="mb-3"><label class="form-label">Phân loại</label>
                            <select class="form-select" id="invCategory"><option>Minibar</option><option>Phòng tắm</option><option>Giường ngủ</option><option>Khác</option></select>
                        </div>
                        <div class="mb-3"><label class="form-label">Số lượng ban đầu</label><input type="number" class="form-control" id="invQty" required></div>
                        <div class="mb-3"><label class="form-label">Đơn vị tính</label><input type="text" class="form-control" id="invUnit" placeholder="Chai, Cái..." required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveInventory()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App Logic -->
    <script>
        // 1. Navigation Logic
        function showSection(sectionId, element) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('d-none'));
            // Show selected section
            document.getElementById(sectionId).classList.remove('d-none');
            
            // Update active nav link
            if(element) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }

            // Load data based on section
            if (sectionId === 'guests') loadGuests();
            if (sectionId === 'reservations') loadReservations();
            if (sectionId === 'dashboard') loadDashboard();
            if (sectionId === 'room-map') loadRoomMap();
            if (sectionId === 'services-inventory') { loadServices(); loadInventory(); }
            if (sectionId === 'analytics') loadAnalytics();
        }

        // 2. API Functions
        const API_BASE = '/api/v1';

        async function loadGuests() {
            try {
                const response = await fetch(`${API_BASE}/guests?page=0&size=20`);
                const data = await response.json();
                const tbody = document.getElementById('guest-table-body');
                tbody.innerHTML = '';

                data.content.forEach(guest => {
                    tbody.innerHTML += `
                        <tr>
                            <td>#${guest.id}</td>
                            <td class="fw-bold">${guest.firstName} ${guest.lastName}</td>
                            <td>${guest.email}</td>
                            <td>${guest.phoneNumber}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="openGuestModal(${guest.id})"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteGuest(${guest.id})"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading guests:', error);
            }
        }

        // Guest Actions
        let guestModal;
        function openGuestModal(id = null) {
            guestModal = new bootstrap.Modal(document.getElementById('guestModal'));
            document.getElementById('guestForm').reset();
            document.getElementById('guestId').value = '';
            
            if(id) {
                fetch(`${API_BASE}/guests/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('guestId').value = data.id;
                        document.getElementById('firstName').value = data.firstName;
                        document.getElementById('lastName').value = data.lastName;
                        document.getElementById('email').value = data.email;
                        document.getElementById('phoneNumber').value = data.phoneNumber;
                        guestModal.show();
                    });
            } else {
                guestModal.show();
            }
        }

        async function saveGuest() {
            const id = document.getElementById('guestId').value;
            const guest = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phoneNumber').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/guests/${id}` : `${API_BASE}/guests`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(guest)
                });
                if(res.ok) {
                    guestModal.hide();
                    loadGuests();
                    alert('Lưu thành công!');
                } else {
                    alert('Có lỗi xảy ra!');
                }
            } catch(e) { console.error(e); }
        }

        async function deleteGuest(id) {
            if(!confirm('Bạn có chắc muốn xóa khách hàng này?')) return;
            await fetch(`${API_BASE}/guests/${id}`, { method: 'DELETE' });
            loadGuests();
        }

        async function searchGuest(keyword) {
            if(keyword.length < 2) { if(keyword.length === 0) loadGuests(); return; }
            const res = await fetch(`${API_BASE}/guests/search?keyword=${keyword}`);
            const data = await res.json();
            const tbody = document.getElementById('guest-table-body');
            tbody.innerHTML = '';
            data.forEach(guest => {
                tbody.innerHTML += `
                    <tr>
                        <td>#${guest.id}</td>
                        <td class="fw-bold">${guest.firstName} ${guest.lastName}</td>
                        <td>${guest.email}</td>
                        <td>${guest.phoneNumber}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openGuestModal(${guest.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGuest(${guest.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        async function loadReservations() {
            try {
                const response = await fetch(`${API_BASE}/reservations?page=0&size=20`);
                const data = await response.json();
                const tbody = document.getElementById('reservation-table-body');
                tbody.innerHTML = '';

                data.content.forEach(res => {
                    const statusClass = `status-${res.status}`;
                    let actions = `<button class="btn btn-sm btn-outline-info" onclick="viewInvoice(${res.id})" title="Hóa đơn"><i class="fa-solid fa-file-invoice-dollar"></i></button>`;
                    
                    if(res.status === 'CONFIRMED') {
                        actions += ` <button class="btn btn-sm btn-outline-success" onclick="updateResStatus(${res.id}, 'check-in')" title="Check-in"><i class="fa-solid fa-check"></i></button>`;
                        actions += ` <button class="btn btn-sm btn-outline-danger" onclick="updateResStatus(${res.id}, 'cancel')" title="Hủy"><i class="fa-solid fa-xmark"></i></button>`;
                    } else if (res.status === 'CHECKED_IN') {
                        actions += ` <button class="btn btn-sm btn-outline-warning" onclick="updateResStatus(${res.id}, 'check-out')" title="Check-out"><i class="fa-solid fa-right-from-bracket"></i></button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><span class="badge bg-secondary">${res.confirmationNumber || res.id}</span></td>
                            <td>${res.guestName}</td>
                            <td><strong>${res.roomNumber}</strong></td>
                            <td>${res.checkInDate}</td>
                            <td>${res.checkOutDate}</td>
                            <td><span class="status-badge ${statusClass}">${res.status}</span></td>
                            <td class="text-success fw-bold">${res.totalAmount ? res.totalAmount.toLocaleString() : 0} đ</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading reservations:', error);
            }
        }

        // Reservation Actions
        function openReservationModal() {
            new bootstrap.Modal(document.getElementById('reservationModal')).show();
        }

        async function createReservation() {
            const data = {
                guestId: document.getElementById('resGuestId').value,
                roomId: document.getElementById('resRoomId').value,
                checkInDate: document.getElementById('checkInDate').value,
                checkOutDate: document.getElementById('checkOutDate').value
            };
            
            const res = await fetch(`${API_BASE}/reservations`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if(res.ok) {
                alert('Đặt phòng thành công!');
                bootstrap.Modal.getInstance(document.getElementById('reservationModal')).hide();
                loadReservations();
            } else {
                alert('Lỗi: Phòng đã kín hoặc dữ liệu không hợp lệ');
            }
        }

        async function updateResStatus(id, action) {
            if(!confirm(`Bạn chắc chắn muốn ${action}?`)) return;
            const res = await fetch(`${API_BASE}/reservations/${id}/${action}`, { method: 'PATCH' });
            if(res.ok) {
                loadReservations();
                if(action === 'check-out') viewInvoice(id); // Show invoice after checkout
            } else {
                const err = await res.json();
                alert('Lỗi: ' + (err.message || 'Không thể thực hiện'));
            }
        }

        async function viewInvoice(id) {
            const res = await fetch(`${API_BASE}/reservations/${id}/invoice`);
            const inv = await res.json();
            const html = `
                <p><strong>Mã HĐ:</strong> ${inv.invoiceNumber || 'Chưa tạo'}</p>
                <p><strong>Tổng tiền:</strong> ${inv.totalAmount ? inv.totalAmount.toLocaleString() : 0} đ</p>
                <hr>
                <p class="text-muted small">Chi tiết dịch vụ và thuế đã được tính toán.</p>
            `;
            document.getElementById('invoiceContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        }

        async function loadDashboard() {
            try {
                const [resOcc, resRev, resGuest, resStatus, resNoti] = await Promise.all([
                    fetch(`${API_BASE}/reports/occupancy`),
                    fetch(`${API_BASE}/reports/revenue`),
                    fetch(`${API_BASE}/reports/guest-stats`),
                    fetch(`${API_BASE}/reports/room-status`),
                    fetch(`${API_BASE}/reports/notifications`)
                ]);

                const occ = await resOcc.json();
                const rev = await resRev.json();
                const guest = await resGuest.json();
                const statusData = await resStatus.json();
                const notiData = await resNoti.json();

                document.getElementById('dash-occupied').innerText = occ.occupiedRooms || 0;
                document.getElementById('dash-revenue').innerText = (rev.totalRevenue || 0).toLocaleString('vi-VN') + ' đ';
                document.getElementById('dash-guests').innerText = guest.totalGuests || 0;

                // 1. Render Room Status Chart (Pie)
                const ctxStatus = document.getElementById('roomStatusChart').getContext('2d');
                if(window.statusChart) window.statusChart.destroy(); // Destroy old chart if exists
                window.statusChart = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: ['Trống', 'Có khách', 'Bảo trì', 'Dọn dẹp'],
                        datasets: [{
                            data: [statusData.AVAILABLE, statusData.OCCUPIED, statusData.MAINTENANCE, statusData.DIRTY],
                            backgroundColor: ['#2ecc71', '#3498db', '#e74c3c', '#f1c40f']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // 2. Render Revenue Chart (Line) - Mock Data for Demo
                const ctxRev = document.getElementById('revenueChart').getContext('2d');
                if(window.revChart) window.revChart.destroy();
                window.revChart = new Chart(ctxRev, {
                    type: 'line',
                    data: {
                        labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
                        datasets: [
                            {
                                label: 'Tuần này',
                                data: rev.thisWeekData || [0,0,0,0,0,0,0], // Data from API
                                borderColor: '#3498db',
                                tension: 0.4
                            },
                            {
                                label: 'Tuần trước',
                                data: rev.lastWeekData || [0,0,0,0,0,0,0],
                                borderColor: '#95a5a6',
                                borderDash: [5, 5],
                                tension: 0.4
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // 3. Render Notifications
                const notiList = document.getElementById('dash-notifications');
                notiList.innerHTML = '';
                if (notiData.length === 0) {
                    notiList.innerHTML = '<div class="text-center text-muted mt-4">Không có thông báo mới</div>';
                } else {
                    notiData.forEach(n => {
                        let icon = n.type === 'SERVICE' ? '<i class="fa-solid fa-bell text-warning me-2"></i>' : '<i class="fa-solid fa-clock text-danger me-2"></i>';
                        notiList.innerHTML += `
                            <div class="list-group-item list-group-item-action d-flex align-items-center">
                                ${icon}
                                <div>
                                    <div class="fw-bold">${n.title}</div>
                                    <small class="text-muted">${n.message}</small>
                                </div>
                            </div>`;
                    });
                }

            } catch (e) { console.error("Lỗi tải dashboard", e); }
        }

        async function loadRoomMap() {
            try {
                const res = await fetch(`${API_BASE}/rooms/map`);
                const rooms = await res.json();
                const container = document.getElementById('room-grid-container');
                container.innerHTML = '';

                rooms.forEach(room => {
                    let statusClass = `status-${room.status}`;
                    let icon = 'fa-bed';
                    let action = '';
                    let info = `<div class="text-muted small">${room.typeName}</div>`;

                    if (room.status === 'AVAILABLE') {
                        icon = 'fa-door-open text-success';
                        action = `onclick="quickBook(${room.id})"`;
                        info += `<div class="text-success fw-bold mt-1">${room.price.toLocaleString()} đ</div>`;
                    } else if (room.status === 'OCCUPIED') {
                        icon = 'fa-user text-danger';
                        action = `onclick="viewInvoice(${room.currentReservationId})"`;
                        info += `<div class="text-danger fw-bold mt-1"><i class="fa-solid fa-user"></i> ${room.guestName || 'Khách'}</div>`;
                    } else {
                        icon = 'fa-broom text-warning';
                        info += `<div class="text-warning fw-bold mt-1">Đang xử lý</div>`;
                    }

                    container.innerHTML += `
                        <div class="card room-card p-3 ${statusClass}" ${action}>
                            <div class="d-flex justify-content-between align-items-start">
                                <h4 class="fw-bold">${room.roomNumber}</h4>
                                <i class="fa-solid ${icon} fa-2x"></i>
                            </div>
                            <div class="mt-2">${info}</div>
                        </div>
                    `;
                });
            } catch (e) { console.error("Lỗi tải sơ đồ phòng", e); }
        }

        function quickBook(roomId) {
            document.getElementById('resRoomId').value = roomId;
            openReservationModal();
        }

        // --- SERVICES & INVENTORY LOGIC ---
        async function loadServices() {
            const res = await fetch(`${API_BASE}/services`);
            const data = await res.json();
            const tbody = document.getElementById('services-table-body');
            tbody.innerHTML = '';
            data.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td class="fw-bold text-success">${s.price.toLocaleString()} đ</td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteService(${s.id})"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        function openServiceModal() { new bootstrap.Modal(document.getElementById('serviceModal')).show(); }

        async function saveService() {
            const data = {
                name: document.getElementById('svcName').value,
                price: document.getElementById('svcPrice').value
            };
            await fetch(`${API_BASE}/services`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            });
            bootstrap.Modal.getInstance(document.getElementById('serviceModal')).hide();
            loadServices();
        }

        async function deleteService(id) {
            if(confirm('Xóa dịch vụ này?')) {
                await fetch(`${API_BASE}/services/${id}`, { method: 'DELETE' });
                loadServices();
            }
        }

        async function loadInventory() {
            const res = await fetch(`${API_BASE}/inventory`);
            const data = await res.json();
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            data.forEach(i => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i.name}</td>
                        <td><span class="badge bg-light text-dark border">${i.category || 'N/A'}</span></td>
                        <td class="fw-bold ${i.quantity < 10 ? 'text-danger' : ''}">${i.quantity}</td>
                        <td>${i.unit}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="updateStock(${i.id}, 1)"><i class="fa-solid fa-plus"></i></button>
                            <button class="btn btn-sm btn-outline-warning" onclick="updateStock(${i.id}, -1)"><i class="fa-solid fa-minus"></i></button>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteInventory(${i.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function openInventoryModal() { new bootstrap.Modal(document.getElementById('inventoryModal')).show(); }

        async function saveInventory() {
            const data = {
                name: document.getElementById('invName').value,
                category: document.getElementById('invCategory').value,
                quantity: document.getElementById('invQty').value,
                unit: document.getElementById('invUnit').value
            };
            await fetch(`${API_BASE}/inventory`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            });
            bootstrap.Modal.getInstance(document.getElementById('inventoryModal')).hide();
            loadInventory();
        }

        async function updateStock(id, change) {
            await fetch(`${API_BASE}/inventory/${id}/stock?quantityChange=${change}`, { method: 'PUT' });
            loadInventory();
        }

        async function deleteInventory(id) {
            if(confirm('Xóa vật tư này?')) { await fetch(`${API_BASE}/inventory/${id}`, { method: 'DELETE' }); loadInventory(); }
        }

        // --- ANALYTICS LOGIC ---
        async function loadAnalytics() {
            // 1. Load Occupancy Chart
            const resOcc = await fetch(`${API_BASE}/reports/occupancy-history`);
            const occData = await resOcc.json();
            
            const ctx = document.getElementById('occupancyHistoryChart').getContext('2d');
            if(window.occHistoryChart) window.occHistoryChart.destroy();
            
            window.occHistoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: occData.labels,
                    datasets: [{
                        label: 'Tỉ lệ lấp đầy (%)',
                        data: occData.data,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // 2. Load Top Guests
            const resGuest = await fetch(`${API_BASE}/reports/top-guests`);
            const guests = await resGuest.json();
            const tbody = document.getElementById('top-guests-body');
            tbody.innerHTML = '';
            guests.forEach(g => {
                tbody.innerHTML += `
                    <tr>
                        <td>${g.firstName} ${g.lastName}</td>
                        <td class="text-end fw-bold text-warning">${g.loyaltyPoints || 0}</td>
                    </tr>`;
            });
        }

        // Init
        loadDashboard();
    </script>
</body>
</html>